Heavily lifted from https://github.com/Narsil/rdev